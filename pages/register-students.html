<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration - CSCI 5403</title>
    <link rel="stylesheet" href="../styles/presentation.css">
    <link rel="icon" type="image/x-icon" href="/images/favicon.png">

    <style>
        body {
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            background: linear-gradient(135deg, #00447c 0%, #003057 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        header h1 {
            margin: 0;
            font-size: 2.5em;
        }

        .card {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .swipe-area {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 3px dashed var(--blueprint-sky);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
        }

        .swipe-area.active {
            border-color: var(--blueprint-purple);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(14, 165, 233, 0.2) 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        #cardInput {
            position: absolute;
            left: -9999px;
            width: 1px;
            height: 1px;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1em;
            display: none;
        }

        .status-message.success {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid #28a745;
            color: #28a745;
            display: block;
        }

        .status-message.error {
            background: rgba(220, 53, 69, 0.2);
            border: 2px solid #dc3545;
            color: #dc3545;
            display: block;
        }

        .students-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-item {
            background: var(--bg-secondary);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--blueprint-sky);
        }

        .student-name {
            font-size: 1.2em;
            font-weight: 500;
        }

        .student-date {
            color: var(--text-muted);
            font-size: 0.9em;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .remove-btn:hover {
            background: #c82333;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: linear-gradient(135deg, var(--blueprint-sky) 0%, var(--blueprint-purple) 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .stat-label {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--blueprint-sky);
            color: white;
        }

        .btn-primary:hover {
            background: var(--blueprint-sky-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--blueprint-sky);
        }

        .btn-secondary:hover {
            background: var(--blueprint-sky);
            color: white;
        }

        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid var(--bg-secondary);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìù Student Registration</h1>
            <p>CSCI 5403 - Software Engineering</p>
        </header>

        <div class="card">
            <h2>Swipe Student Card to Register</h2>

            <div class="swipe-area active" id="swipeArea">
                <h3>üé¥ Ready to Scan</h3>
                <p>Swipe a student ID card to register them for the course</p>
                <p style="font-size: 0.9em; color: var(--text-muted); margin-top: 10px;">
                    Click here first, then swipe the card
                </p>
            </div>

            <input type="text" id="cardInput" autocomplete="off">

            <div id="statusMessage" class="status-message"></div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Total Students</div>
                    <div class="stat-number" id="totalStudents">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Registered Today</div>
                    <div class="stat-number" id="todayCount">0</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Registered Students</h2>
            <div class="students-list" id="studentsList">
                <p style="text-align: center; color: var(--text-muted); padding: 20px;">
                    No students registered yet. Swipe a card to begin.
                </p>
            </div>

            <div class="export-section">
                <h3>Actions</h3>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="exportToCSV()">üì• Export to CSV</button>
                    <button class="btn btn-secondary" onclick="clearAllStudents()">üóëÔ∏è Clear All Students</button>
                    <a href="../index.html" class="btn btn-secondary">üè† Back to Home</a>
                    <a href="./attendance.html" class="btn btn-primary">‚úì Take Attendance</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Storage key
        const STORAGE_KEY = 'csci5403_students';

        // Get registered students from localStorage
        function getStudents() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        // Save students to localStorage
        function saveStudents(students) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(students));
            updateUI();
        }

        // Parse card swipe data
        function parseCardData(rawData) {
            // Format: %B6039500482025215^REED/BOBBY^2108701B00122548?;6039500482025215=2108701000122548?
            // We want the data between the ^ symbols: REED/BOBBY
            const match = rawData.match(/\^([^\/]+)\/([^\^]+)\^/);

            if (match) {
                const lastName = match[1].trim();
                const firstName = match[2].trim();
                return {
                    lastName,
                    firstName,
                    fullName: `${firstName} ${lastName}`,
                    rawData: rawData
                };
            }
            return null;
        }

        // Show status message
        function showStatus(message, isSuccess = true) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${isSuccess ? 'success' : 'error'}`;

            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // Register a student
        function registerStudent(studentData) {
            const students = getStudents();

            // Check if student already registered
            const exists = students.find(s =>
                s.lastName === studentData.lastName &&
                s.firstName === studentData.firstName
            );

            if (exists) {
                showStatus(`${studentData.fullName} is already registered!`, false);
                return false;
            }

            // Add new student
            const newStudent = {
                ...studentData,
                registeredDate: new Date().toISOString(),
                id: Date.now()
            };

            students.push(newStudent);
            saveStudents(students);
            showStatus(`‚úì ${studentData.fullName} registered successfully!`, true);
            return true;
        }

        // Remove a student
        function removeStudent(studentId) {
            if (!confirm('Are you sure you want to remove this student?')) {
                return;
            }

            const students = getStudents();
            const filtered = students.filter(s => s.id !== studentId);
            saveStudents(filtered);
            showStatus('Student removed successfully', true);
        }

        // Update UI
        function updateUI() {
            const students = getStudents();
            const studentsList = document.getElementById('studentsList');
            const totalStudents = document.getElementById('totalStudents');
            const todayCount = document.getElementById('todayCount');

            // Update stats
            totalStudents.textContent = students.length;

            // Count students registered today
            const today = new Date().toDateString();
            const registeredToday = students.filter(s =>
                new Date(s.registeredDate).toDateString() === today
            ).length;
            todayCount.textContent = registeredToday;

            // Update students list
            if (students.length === 0) {
                studentsList.innerHTML = `
                    <p style="text-align: center; color: var(--text-muted); padding: 20px;">
                        No students registered yet. Swipe a card to begin.
                    </p>
                `;
            } else {
                // Sort by last name
                students.sort((a, b) => a.lastName.localeCompare(b.lastName));

                studentsList.innerHTML = students.map(student => `
                    <div class="student-item">
                        <div>
                            <div class="student-name">${student.fullName}</div>
                            <div class="student-date">
                                Registered: ${new Date(student.registeredDate).toLocaleDateString('en-US', {
                                    month: 'short',
                                    day: 'numeric',
                                    year: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </div>
                        </div>
                        <button class="remove-btn" onclick="removeStudent(${student.id})">Remove</button>
                    </div>
                `).join('');
            }
        }

        // Export to CSV
        function exportToCSV() {
            const students = getStudents();
            if (students.length === 0) {
                alert('No students to export');
                return;
            }

            // Create CSV content
            const headers = ['Last Name', 'First Name', 'Full Name', 'Registration Date'];
            const rows = students.map(s => [
                s.lastName,
                s.firstName,
                s.fullName,
                new Date(s.registeredDate).toLocaleString()
            ]);

            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `csci5403-students-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Clear all students
        function clearAllStudents() {
            if (!confirm('Are you sure you want to remove ALL students? This cannot be undone!')) {
                return;
            }

            if (confirm('Really? This will delete all registration data!')) {
                localStorage.removeItem(STORAGE_KEY);
                updateUI();
                showStatus('All students removed', true);
            }
        }

        // Handle card input
        const cardInput = document.getElementById('cardInput');
        const swipeArea = document.getElementById('swipeArea');

        // Focus input when clicking swipe area
        swipeArea.addEventListener('click', () => {
            cardInput.focus();
        });

        // Keep input focused, but not when interacting with buttons
        cardInput.addEventListener('blur', (e) => {
            // Don't refocus if user clicked a button or link
            if (e.relatedTarget && (e.relatedTarget.tagName === 'BUTTON' || e.relatedTarget.tagName === 'A')) {
                return;
            }
            setTimeout(() => cardInput.focus(), 100);
        });

        // Handle card swipe
        cardInput.addEventListener('input', (e) => {
            const value = e.target.value;

            // Card data typically ends with ?
            if (value.includes('?')) {
                const studentData = parseCardData(value);

                if (studentData) {
                    registerStudent(studentData);
                } else {
                    showStatus('Could not read card data. Please try again.', false);
                }

                // Clear input
                cardInput.value = '';
            }
        });

        // Initialize
        updateUI();
        cardInput.focus();

        // Keep focus on input, but not when interacting with UI elements
        setInterval(() => {
            const activeElement = document.activeElement;
            // Only refocus if nothing else is focused or if body is focused
            if (!activeElement || activeElement === document.body) {
                cardInput.focus();
            }
        }, 1000);
    </script>
</body>
</html>
